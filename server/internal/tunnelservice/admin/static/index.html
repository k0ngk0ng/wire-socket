<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WireSocket Tunnel Admin</title>
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --danger: #dc2626;
            --success: #16a34a;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            background: var(--primary);
            color: white;
            padding: 16px 20px;
            margin-bottom: 24px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { font-size: 1.5rem; }
        .header-info { font-size: 0.875rem; opacity: 0.9; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab {
            padding: 10px 20px;
            border: none;
            background: var(--card);
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .tab:hover { color: var(--primary); }
        .tab.active { background: var(--primary); color: white; }
        .card {
            background: var(--card);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title { font-size: 1.125rem; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
        tr:hover { background: #f9fafb; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { opacity: 0.9; }
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; }
        .btn-group { display: flex; gap: 4px; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card);
            padding: 24px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 4px; font-size: 0.875rem; font-weight: 500; }
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(5,150,105,0.1);
        }
        .form-checkbox { display: flex; align-items: center; gap: 8px; }
        .form-checkbox input { width: 16px; height: 16px; }
        .alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 0.875rem; }
        .alert-success { background: #dcfce7; color: #166534; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .hidden { display: none !important; }
        code { font-size: 0.8rem; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WireSocket Tunnel Admin</h1>
            <div class="header-info">Local Management Console</div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('routes')">Routes</button>
            <button class="tab" onclick="showTab('nat')">NAT Rules</button>
        </div>

        <!-- Routes Tab -->
        <div id="tab-routes" class="card">
            <div class="card-header">
                <h3 class="card-title">Routes</h3>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="applyRoutes()">Apply Routes</button>
                    <button class="btn btn-primary" onclick="showRouteModal()">Add Route</button>
                </div>
            </div>
            <div id="routes-message" class="hidden"></div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>CIDR</th>
                        <th>Gateway</th>
                        <th>Device</th>
                        <th>Metric</th>
                        <th>Push</th>
                        <th>Apply</th>
                        <th>Enabled</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="routes-table"></tbody>
            </table>
        </div>

        <!-- NAT Tab -->
        <div id="tab-nat" class="card hidden">
            <div class="card-header">
                <h3 class="card-title">NAT Rules</h3>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="applyNATRules()">Apply NAT</button>
                    <button class="btn btn-primary" onclick="showNATModal()">Add NAT Rule</button>
                </div>
            </div>
            <div id="nat-message" class="hidden"></div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Interface</th>
                        <th>Details</th>
                        <th>Enabled</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="nat-table"></tbody>
            </table>
        </div>
    </div>

    <!-- Route Modal -->
    <div id="route-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="route-modal-title">Add Route</h3>
                <button class="modal-close" onclick="closeRouteModal()">&times;</button>
            </div>
            <div id="route-modal-error" class="alert alert-error hidden"></div>
            <form id="route-form" onsubmit="saveRoute(event)">
                <input type="hidden" id="route-id">
                <div class="form-group">
                    <label class="form-label">CIDR *</label>
                    <input type="text" id="route-cidr" class="form-input" placeholder="192.168.1.0/24" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Gateway</label>
                    <input type="text" id="route-gateway" class="form-input" placeholder="(optional)">
                </div>
                <div class="form-group">
                    <label class="form-label">Device</label>
                    <input type="text" id="route-device" class="form-input" placeholder="(optional)">
                </div>
                <div class="form-group">
                    <label class="form-label">Metric</label>
                    <input type="number" id="route-metric" class="form-input" value="0" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Comment</label>
                    <input type="text" id="route-comment" class="form-input" placeholder="(optional)">
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="route-push" checked>
                        <span>Push to Client</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="route-apply">
                        <span>Apply on Server</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="route-enabled" checked>
                        <span>Enabled</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save</button>
            </form>
        </div>
    </div>

    <!-- NAT Modal -->
    <div id="nat-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="nat-modal-title">Add NAT Rule</h3>
                <button class="modal-close" onclick="closeNATModal()">&times;</button>
            </div>
            <div id="nat-modal-error" class="alert alert-error hidden"></div>
            <form id="nat-form" onsubmit="saveNATRule(event)">
                <input type="hidden" id="nat-id">
                <div class="form-group">
                    <label class="form-label">Type *</label>
                    <select id="nat-type" class="form-select" required onchange="updateNATFields()">
                        <option value="masquerade">Masquerade</option>
                        <option value="snat">SNAT</option>
                        <option value="dnat">DNAT</option>
                        <option value="tcpmss">TCP MSS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Interface *</label>
                    <input type="text" id="nat-interface" class="form-input" placeholder="eth0" required>
                </div>
                <div id="nat-snat-fields" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <input type="text" id="nat-source" class="form-input" placeholder="10.0.0.0/24">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Source</label>
                        <input type="text" id="nat-to-source" class="form-input" placeholder="192.168.1.1">
                    </div>
                </div>
                <div id="nat-dnat-fields" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Protocol</label>
                        <input type="text" id="nat-protocol" class="form-input" placeholder="tcp">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Port</label>
                        <input type="number" id="nat-port" class="form-input" placeholder="8080">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Destination</label>
                        <input type="text" id="nat-to-dest" class="form-input" placeholder="10.0.0.5:80">
                    </div>
                </div>
                <div id="nat-mss-fields" class="hidden">
                    <div class="form-group">
                        <label class="form-label">MSS Value</label>
                        <input type="number" id="nat-mss" class="form-input" placeholder="1400">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="nat-enabled" checked>
                        <span>Enabled</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save</button>
            </form>
        </div>
    </div>

    <script>
        // Load data on page load
        loadRoutes();
        loadNATRules();

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-routes').classList.add('hidden');
            document.getElementById('tab-nat').classList.add('hidden');
            document.getElementById('tab-' + tab).classList.remove('hidden');
        }

        // Routes
        async function loadRoutes() {
            try {
                const res = await fetch('/api/admin/routes');
                const data = await res.json();
                renderRoutes(data.routes || []);
            } catch (e) {
                console.error('Failed to load routes:', e);
            }
        }

        function renderRoutes(routes) {
            const tbody = document.getElementById('routes-table');
            if (routes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#999;">No routes configured</td></tr>';
                return;
            }
            tbody.innerHTML = routes.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td><code>${r.cidr}</code></td>
                    <td>${r.gateway || '-'}</td>
                    <td>${r.device || '-'}</td>
                    <td>${r.metric || 0}</td>
                    <td>${r.push_to_client ? '<span class="badge badge-success">Yes</span>' : '-'}</td>
                    <td>${r.apply_on_server ? '<span class="badge badge-info">Yes</span>' : '-'}</td>
                    <td><span class="badge ${r.enabled ? 'badge-success' : 'badge-danger'}">${r.enabled ? 'Yes' : 'No'}</span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-primary" onclick="editRoute(${r.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRoute(${r.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function showRouteModal(route = null) {
            const modal = document.getElementById('route-modal');
            const title = document.getElementById('route-modal-title');

            document.getElementById('route-id').value = route ? route.id : '';
            document.getElementById('route-cidr').value = route ? route.cidr : '';
            document.getElementById('route-gateway').value = route ? route.gateway : '';
            document.getElementById('route-device').value = route ? route.device : '';
            document.getElementById('route-metric').value = route ? route.metric : 0;
            document.getElementById('route-comment').value = route ? route.comment : '';
            document.getElementById('route-push').checked = route ? route.push_to_client : true;
            document.getElementById('route-apply').checked = route ? route.apply_on_server : false;
            document.getElementById('route-enabled').checked = route ? route.enabled : true;

            title.textContent = route ? 'Edit Route' : 'Add Route';
            modal.classList.add('active');
        }

        function closeRouteModal() {
            document.getElementById('route-modal').classList.remove('active');
            document.getElementById('route-modal-error').classList.add('hidden');
        }

        async function editRoute(id) {
            try {
                const res = await fetch('/api/admin/routes');
                const data = await res.json();
                const route = (data.routes || []).find(r => r.id === id);
                if (route) showRouteModal(route);
            } catch (e) {
                console.error('Failed to load route:', e);
            }
        }

        async function saveRoute(e) {
            e.preventDefault();
            const errorEl = document.getElementById('route-modal-error');
            const id = document.getElementById('route-id').value;
            const body = {
                cidr: document.getElementById('route-cidr').value,
                gateway: document.getElementById('route-gateway').value,
                device: document.getElementById('route-device').value,
                metric: parseInt(document.getElementById('route-metric').value) || 0,
                comment: document.getElementById('route-comment').value,
                push_to_client: document.getElementById('route-push').checked,
                apply_on_server: document.getElementById('route-apply').checked,
                enabled: document.getElementById('route-enabled').checked
            };

            try {
                const url = id ? '/api/admin/routes/' + id : '/api/admin/routes';
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to save route';
                    errorEl.classList.remove('hidden');
                    return;
                }

                closeRouteModal();
                loadRoutes();
            } catch (e) {
                errorEl.textContent = 'Connection error';
                errorEl.classList.remove('hidden');
            }
        }

        async function deleteRoute(id) {
            if (!confirm('Are you sure you want to delete this route?')) return;
            try {
                await fetch('/api/admin/routes/' + id, { method: 'DELETE' });
                loadRoutes();
            } catch (e) {
                console.error('Failed to delete route:', e);
            }
        }

        async function applyRoutes() {
            try {
                const res = await fetch('/api/admin/routes/apply', { method: 'POST' });
                const data = await res.json();
                showMessage('routes', res.ok ? 'success' : 'error', data.message || data.error || 'Routes applied');
            } catch (e) {
                showMessage('routes', 'error', 'Failed to apply routes');
            }
        }

        // NAT Rules
        async function loadNATRules() {
            try {
                const res = await fetch('/api/admin/nat');
                const data = await res.json();
                renderNATRules(data.rules || []);
            } catch (e) {
                console.error('Failed to load NAT rules:', e);
            }
        }

        function renderNATRules(rules) {
            const tbody = document.getElementById('nat-table');
            if (rules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">No NAT rules configured</td></tr>';
                return;
            }
            tbody.innerHTML = rules.map(r => {
                let details = '-';
                if (r.type === 'snat') details = `${r.source || '*'} -> ${r.to_source}`;
                else if (r.type === 'dnat') details = `${r.protocol}:${r.port} -> ${r.to_destination}`;
                else if (r.type === 'tcpmss') details = `MSS=${r.mss}`;

                return `
                    <tr>
                        <td>${r.id}</td>
                        <td><span class="badge badge-info">${r.type}</span></td>
                        <td><code>${r.interface}</code></td>
                        <td>${details}</td>
                        <td><span class="badge ${r.enabled ? 'badge-success' : 'badge-danger'}">${r.enabled ? 'Yes' : 'No'}</span></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger" onclick="deleteNATRule(${r.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showNATModal() {
            const modal = document.getElementById('nat-modal');
            document.getElementById('nat-id').value = '';
            document.getElementById('nat-type').value = 'masquerade';
            document.getElementById('nat-interface').value = '';
            document.getElementById('nat-source').value = '';
            document.getElementById('nat-to-source').value = '';
            document.getElementById('nat-protocol').value = '';
            document.getElementById('nat-port').value = '';
            document.getElementById('nat-to-dest').value = '';
            document.getElementById('nat-mss').value = '';
            document.getElementById('nat-enabled').checked = true;
            updateNATFields();
            modal.classList.add('active');
        }

        function closeNATModal() {
            document.getElementById('nat-modal').classList.remove('active');
            document.getElementById('nat-modal-error').classList.add('hidden');
        }

        function updateNATFields() {
            const type = document.getElementById('nat-type').value;
            document.getElementById('nat-snat-fields').classList.add('hidden');
            document.getElementById('nat-dnat-fields').classList.add('hidden');
            document.getElementById('nat-mss-fields').classList.add('hidden');

            if (type === 'snat') document.getElementById('nat-snat-fields').classList.remove('hidden');
            else if (type === 'dnat') document.getElementById('nat-dnat-fields').classList.remove('hidden');
            else if (type === 'tcpmss') document.getElementById('nat-mss-fields').classList.remove('hidden');
        }

        async function saveNATRule(e) {
            e.preventDefault();
            const errorEl = document.getElementById('nat-modal-error');
            const body = {
                type: document.getElementById('nat-type').value,
                interface: document.getElementById('nat-interface').value,
                source: document.getElementById('nat-source').value,
                to_source: document.getElementById('nat-to-source').value,
                protocol: document.getElementById('nat-protocol').value,
                port: parseInt(document.getElementById('nat-port').value) || 0,
                to_destination: document.getElementById('nat-to-dest').value,
                mss: parseInt(document.getElementById('nat-mss').value) || 0,
                enabled: document.getElementById('nat-enabled').checked
            };

            try {
                const res = await fetch('/api/admin/nat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (!res.ok) {
                    errorEl.textContent = data.error || 'Failed to save NAT rule';
                    errorEl.classList.remove('hidden');
                    return;
                }

                closeNATModal();
                loadNATRules();
            } catch (e) {
                errorEl.textContent = 'Connection error';
                errorEl.classList.remove('hidden');
            }
        }

        async function deleteNATRule(id) {
            if (!confirm('Are you sure you want to delete this NAT rule?')) return;
            try {
                await fetch('/api/admin/nat/' + id, { method: 'DELETE' });
                loadNATRules();
            } catch (e) {
                console.error('Failed to delete NAT rule:', e);
            }
        }

        async function applyNATRules() {
            try {
                const res = await fetch('/api/admin/nat/apply', { method: 'POST' });
                const data = await res.json();
                showMessage('nat', res.ok ? 'success' : 'error', data.message || data.error || 'NAT rules applied');
            } catch (e) {
                showMessage('nat', 'error', 'Failed to apply NAT rules');
            }
        }

        function showMessage(tab, type, message) {
            const el = document.getElementById(tab + '-message');
            el.textContent = message;
            el.className = type === 'success' ? 'alert alert-success' : 'alert alert-error';
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
    </script>
</body>
</html>
